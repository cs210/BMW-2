{"version":3,"sources":["../../src/server/AsteroidsServerEngine.js"],"names":["AsteroidsServerEngine","io","gameEngine","inputOptions","physicsEngine","world","on","handleCollision","bind","shoot","playerReady","playerGroups","currentWorld","addBarriers","evt","A","B","forEachObject","id","obj","physicsObj","bodyA","bodyB","trace","toString","Bullet","Asteroid","explode","Ship","resetShip","FinishLine","gameWon","player","radius","shapes","angle","Math","PI","bullet","mass","position","TwoVector","cos","sin","velocity","angularVelocity","addObjectToWorld","timer","add","bulletLifeTime","destroyBullet","bulletId","objects","removeObjectFromWorld","ship","won","score","removeAllBarriers","queryObjects","instanceType","length","console","log","resetAllShips","groupCode","c_socketID","to","emit","v_socketID","socket","that","data","connectedPlayers","playerName","privateCode","full","v_playerID","playerId","v_playerName","sendGroupUpdate","c_playerID","c_playerName","c_ready","v_ready","gameStarted","group","addShip","ship_pid","viewer","switchedGroup","socketId","group_code","o","ServerEngine"],"mappings":"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","sourcesContent":["import { ServerEngine, TwoVector } from 'lance-gg';\nimport Asteroid from '../common/Asteroid';\nimport Bullet from '../common/Bullet';\nimport Ship from '../common/Ship';\nimport FinishLine from \"../common/FinishLine\";\n\nexport default class AsteroidsServerEngine extends ServerEngine {\n\n    constructor(io, gameEngine, inputOptions) {\n        super(io, gameEngine, inputOptions);\n        gameEngine.physicsEngine.world.on('beginContact', this.handleCollision.bind(this));\n        gameEngine.on('shoot', this.shoot.bind(this));\n        this.playerReady = {};\n        this.playerGroups = {};\n        this.currentWorld = 0;\n        // maps groupCode -> {\n        // c_playerID : int,\n        // c_playerName : str,\n        // c_socketID : int,\n        // v_playerID : int,\n        // v_playerName : int,\n        // v_socketID : int,\n        // full : bool,\n        // c_ready : bool,\n        // v_ready : bool,\n        // gameStarted: bool\n        // };\n        this.io = io;\n    }\n\n    start() {\n        super.start();\n        this.gameEngine.addBarriers();\n    }\n\n    // handle a collision on server only\n    handleCollision(evt) {\n        // identify the two objects which collided\n        let A;\n        let B;\n        this.gameEngine.world.forEachObject((id, obj) => {\n            if (obj.physicsObj === evt.bodyA) A = obj;\n            if (obj.physicsObj === evt.bodyB) B = obj;\n        });\n\n        // check bullet-asteroid and ship-asteroid collisions\n        if (!A || !B) return;\n        this.gameEngine.trace.trace(() => `collision between A=${A.toString()}`);\n        this.gameEngine.trace.trace(() => `collision and     B=${B.toString()}`);\n        if (A instanceof Bullet && B instanceof Asteroid) this.gameEngine.explode(B, A);\n        if (B instanceof Bullet && A instanceof Asteroid) this.gameEngine.explode(A, B);\n        if (A instanceof Ship && B instanceof Asteroid) this.gameEngine.resetShip(A);\n        if (B instanceof Ship && A instanceof Asteroid) this.gameEngine.resetShip(B);\n        if (A instanceof Ship && B instanceof FinishLine) this.gameWon(A);\n        if (B instanceof Ship && A instanceof FinishLine) this.gameWon(B);\n    }\n\n    // shooting creates a bullet\n    shoot(player) {\n        let radius = player.physicsObj.shapes[0].radius;\n        let angle = player.physicsObj.angle + Math.PI / 2;\n        let bullet = new Bullet(this.gameEngine, {}, {\n            mass: 0.05,\n            position: new TwoVector(\n                radius * Math.cos(angle) + player.physicsObj.position[0],\n                radius * Math.sin(angle) + player.physicsObj.position[1]\n            ),\n            velocity: new TwoVector(\n                2 * Math.cos(angle) + player.physicsObj.velocity[0],\n                2 * Math.sin(angle) + player.physicsObj.velocity[1]\n            ),\n            angularVelocity: 0\n        });\n        let obj = this.gameEngine.addObjectToWorld(bullet);\n        this.gameEngine.timer.add(this.gameEngine.bulletLifeTime, this.destroyBullet, this, [obj.id]);\n    }\n\n    // destroy the missile if it still exists\n    destroyBullet(bulletId) {\n        if (this.gameEngine.world.objects[bulletId]) {\n            this.gameEngine.trace.trace(() => `bullet[${bulletId}] destroyed`);\n            this.gameEngine.removeObjectFromWorld(bulletId);\n        }\n    }\n\n    gameWon(ship) {\n        ship.won = true;\n        ship.score++;\n        this.gameEngine.removeAllBarriers();\n        // restart game\n        if (this.gameEngine.world.queryObjects({ instanceType: Asteroid }).length === 0) {\n            console.log(\"restarting\");\n            this.currentWorld = this.gameEngine.addBarriers(this.currentWorld);\n            this.gameEngine.resetAllShips();\n        } else {\n            console.log(\"Error: not all barriers were removed.\");\n        }\n    }\n\n    sendGroupUpdate(groupCode) {\n        if (groupCode) {\n            if (this.playerGroups[groupCode].c_socketID) {\n                this.io.to(this.playerGroups[groupCode].c_socketID).emit('groupUpdate', this.playerGroups[groupCode]);\n            }\n            if (this.playerGroups[groupCode].v_socketID) {\n                this.io.to(this.playerGroups[groupCode].v_socketID).emit('groupUpdate', this.playerGroups[groupCode]);\n            }\n        }\n    }\n\n    onPlayerConnected(socket) {\n        super.onPlayerConnected(socket);\n        let that = this;\n        socket.on('playerDataUpdate', function(data) {\n            that.connectedPlayers[socket.id].playerName = data.playerName;\n            that.connectedPlayers[socket.id].privateCode = data.privateCode;\n            if (data.privateCode in that.playerGroups) {\n                if (that.playerGroups[data.privateCode].full) {\n                    socket.emit('groupFull');\n                } else {\n                    if (that.playerGroups[data.privateCode].v_playerID === null) {\n                        that.playerGroups[data.privateCode].v_playerID = socket.playerId;\n                        that.playerGroups[data.privateCode].v_playerName = data.playerName;\n                        that.playerGroups[data.privateCode].v_socketID = socket.id;\n                        that.playerGroups[data.privateCode].full = true;\n                        socket.emit('waitingForPlayer');\n                        that.sendGroupUpdate(data.privateCode);\n                    } else {\n                        that.playerGroups[data.privateCode].c_playerID = socket.playerId;\n                        that.playerGroups[data.privateCode].c_playerName = data.playerName;\n                        that.playerGroups[data.privateCode].c_socketID = socket.id;\n                        that.playerGroups[data.privateCode].full = true;\n                        socket.emit('waitingForPlayer');\n                        that.sendGroupUpdate(data.privateCode);\n                    }\n                }\n            } else {\n                that.playerGroups[data.privateCode] = {\n                    c_playerID : socket.playerId,\n                    c_playerName : data.playerName,\n                    c_socketID : socket.id,\n                    v_playerID : null,\n                    v_playerName : null,\n                    v_socketID : null,\n                    full : false,\n                    c_ready : false,\n                    v_ready : false,\n                    gameStarted: false\n                };\n                socket.emit('waitingForPlayer');\n                that.sendGroupUpdate(data.privateCode);\n            }\n        });\n\n        socket.on('playerReady', function() {\n            let groupCode = that.connectedPlayers[socket.id].privateCode;\n            if (that.playerGroups[groupCode].v_socketID === socket.id) {\n                that.playerGroups[groupCode].v_ready = !that.playerGroups[groupCode].v_ready;\n            } else {\n                that.playerGroups[groupCode].c_ready = !that.playerGroups[groupCode].c_ready;\n            }\n            that.sendGroupUpdate(groupCode);\n\n            // Check for start game\n            let group = that.playerGroups[that.connectedPlayers[socket.id].privateCode];\n            if (group.v_ready && group.c_ready) {\n                that.gameEngine.addShip(group.c_playerID, group.c_playerName, group.v_playerName);\n                that.gameEngine.playerReady[group.c_playerID] = true;\n                that.io.to(group.c_socketID).emit('gameBegin', {\n                    ship_pid : group.c_playerID,\n                    viewer : false\n                });\n                that.io.to(group.v_socketID).emit('gameBegin', {\n                    ship_pid : group.c_playerID,\n                    viewer : true\n                });\n                that.playerGroups[that.connectedPlayers[socket.id].privateCode].gameStarted = true;\n            }\n        });\n\n        socket.on('playerSwitchRole', function() {\n            let groupCode = that.connectedPlayers[socket.id].privateCode;\n            let switchedGroup = {\n                c_playerID : that.playerGroups[groupCode].v_playerID,\n                c_playerName : that.playerGroups[groupCode].v_playerName,\n                c_socketID : that.playerGroups[groupCode].v_socketID,\n                v_playerID : that.playerGroups[groupCode].c_playerID,\n                v_playerName : that.playerGroups[groupCode].c_playerName,\n                v_socketID : that.playerGroups[groupCode].c_socketID,\n                full : that.playerGroups[groupCode].full,\n                c_ready : that.playerGroups[groupCode].v_ready,\n                v_ready : that.playerGroups[groupCode].c_ready,\n                gameStarted: false\n            }\n            that.playerGroups[groupCode] = switchedGroup;\n            that.sendGroupUpdate(groupCode);\n        });\n    }\n\n    onPlayerDisconnected(socketId, playerId) {\n        let group_code = this.connectedPlayers[socketId].privateCode;\n        super.onPlayerDisconnected(socketId, playerId);\n        if (group_code && this.playerGroups[group_code]) {\n            if (playerId === this.playerGroups[group_code].c_playerID) {\n                this.playerGroups[group_code].c_playerID = null;\n                this.playerGroups[group_code].c_socketID = null;\n                this.playerGroups[group_code].c_playerName = null;\n                this.playerGroups[group_code].c_ready = false;\n                this.playerGroups[group_code].full = false;\n                if (this.playerGroups[group_code].v_socketID) {\n                    this.io.to(this.playerGroups[group_code].v_socketID).emit('groupUpdate', this.playerGroups[group_code]);\n                }\n            } else {\n                this.playerGroups[group_code].v_playerID = null;\n                this.playerGroups[group_code].v_socketID = null;\n                this.playerGroups[group_code].v_playerName = null;\n                this.playerGroups[group_code].v_ready = false;\n                this.playerGroups[group_code].full = false;\n                if (this.playerGroups[group_code].c_socketID) {\n                    this.io.to(this.playerGroups[group_code].c_socketID).emit('groupUpdate', this.playerGroups[group_code]);\n                }\n            }\n\n            //console.log(this.playerGroups[group_code]);\n            if (this.playerGroups[group_code] && this.playerGroups[group_code].c_socketID === null && this.playerGroups[group_code].v_socketID === null) {\n                //console.log(group_code + ' has been deleted.');\n                delete this.playerGroups[group_code];\n            }\n\n            if (this.playerGroups[group_code] && this.playerGroups[group_code].c_playerID && playerId !== this.playerGroups[group_code].c_playerID) {\n                for (let o of this.gameEngine.world.queryObjects({\n                    playerId : this.playerGroups[group_code].c_playerID\n                })) {\n                    this.gameEngine.removeObjectFromWorld(o.id);\n                }\n            }\n        }\n        for (let o of this.gameEngine.world.queryObjects({ playerId }))\n            this.gameEngine.removeObjectFromWorld(o.id);\n\n    }\n}\n"],"file":"AsteroidsServerEngine.js"}