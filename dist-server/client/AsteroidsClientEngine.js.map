{"version":3,"sources":["../../src/client/AsteroidsClientEngine.js"],"names":["$","require","betaTiltThreshold","gammaTiltThreshold","steerThreshold","AsteroidsClientEngine","gameEngine","options","AsteroidsRenderer","playerOptions","isTouchDevice","document","querySelector","classList","remove","actions","Set","fireButton","style","opacity","boostButton","window","addEventListener","handleOrientation","bind","handleButton","on","preStep","controls","KeyboardControls","bindKey","repeat","action","ev","add","preventDefault","event","isPortrait","innerHeight","innerWidth","beta","gamma","flip","steerValue","Math","max","min","forEach","sendInput","movement","connectSocket","matchMakerAnswer","Promise","resolve","reject","status","verbose","console","log","serverURL","socket","networkMonitor","registerClient","error","playerData","playerId","messageIndex","Number","emit","data","getElementById","display","viewer","renderer","click","visibility","playerReady","groupShipPID","ship_pid","alert","groupData","innerHTML","c_playerName","v_playerName","c_ready","v_ready","worldData","inboundMessages","push","roomData","reason","disconnect","matchmaker","Utils","httpGetPromise","then","ClientEngine","navigator","maxTouchPoints"],"mappings":"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","sourcesContent":["import { ClientEngine, KeyboardControls } from 'lance-gg';\nimport AsteroidsRenderer from '../client/AsteroidsRenderer';\nimport Utils from \"lance-gg/src/lib/Utils\";\nimport io from 'socket.io-client';\nconst $ = require('jquery');\n\nconst betaTiltThreshold = 40;\nconst gammaTiltThreshold = 40;\nconst steerThreshold = 0.4;\n\nexport default class AsteroidsClientEngine extends ClientEngine {\n\n    constructor(gameEngine, options) {\n        super(gameEngine, options, AsteroidsRenderer);\n        this.playerOptions = options.playerOptions;\n        //  Game input\n        if (isTouchDevice()) {\n            document.querySelector('#instructionsMobile').classList.remove('hidden');\n\n            this.actions = new Set();\n\n            this.fireButton = document.querySelector('.fireButton');\n            this.fireButton.style.opacity = 1;\n            this.boostButton = document.querySelector('.boostButton');\n            this.boostButton.style.opacity = 1;\n            window.addEventListener('deviceorientation', this.handleOrientation.bind(this));\n            this.fireButton.addEventListener('touchstart', this.handleButton.bind(this, 'space'), false);\n            this.boostButton.addEventListener('touchstart', this.handleButton.bind(this, 'up'), false);\n            this.gameEngine.on('client__preStep', this.preStep.bind(this));\n        } else {\n            document.querySelector('#instructions').classList.remove('hidden');\n            this.controls = new KeyboardControls(this);\n            this.controls.bindKey('up', 'up', { repeat: true } );\n            this.controls.bindKey('down', 'down', { repeat: true } );\n            this.controls.bindKey('left', 'left', { repeat: true } );\n            this.controls.bindKey('right', 'right', { repeat: true } );\n            this.controls.bindKey('space', 'space');\n        }\n    }\n\n    handleButton(action, ev) {\n        this.actions.add(action);\n        ev.preventDefault();\n    }\n\n    handleOrientation(event) {\n        let isPortrait = window.innerHeight > window.innerWidth;\n        let beta = event.beta;  // In degree in the range [-180,180]\n        let gamma = event.gamma; // In degree in the range [-90,90]\n        let flip = gamma > 0;\n        let steerValue = Math.max(-1, Math.min(1, beta / betaTiltThreshold)) * (flip?-1:1);\n        if (isPortrait) {\n            flip = beta < 0;\n            steerValue = Math.max(-1, Math.min(1, gamma / gammaTiltThreshold)) * (flip?-1:1);\n        }\n\n        this.actions.delete('left');\n        this.actions.delete('right');\n        if (steerValue < -steerThreshold) this.actions.add('left');\n        else if (steerValue > steerThreshold) this.actions.add('right');\n    }\n\n    // our pre-step is to process inputs that are \"currently pressed\" during the game step\n    preStep() {\n        this.actions.forEach((action) => this.sendInput(action, { movement: true }));\n        this.actions = new Set();\n    }\n\n    /**\n     * Makes a connection to the game server.  Extend this method if you want to add additional\n     * logic on every connection. Call the super-class connect first, and return a promise which\n     * executes when the super-class promise completes.\n     *\n     * @param {Object} [options] additional socket.io options\n     * @return {Promise} Resolved when the connection is made to the server\n     */\n    connect(options = {}) {\n\n        let connectSocket = matchMakerAnswer => {\n            return new Promise((resolve, reject) => {\n\n                if (matchMakerAnswer.status !== 'ok')\n                    reject('matchMaker failed status: ' + matchMakerAnswer.status);\n\n                if (this.options.verbose)\n                    console.log(`connecting to game server ${matchMakerAnswer.serverURL}`);\n                this.socket = io(matchMakerAnswer.serverURL, options);\n\n                this.networkMonitor.registerClient(this);\n\n                this.socket.on('connect', () => {\n                    if (this.options.verbose)\n                        console.log('connection made');\n                    resolve();\n                });\n\n                this.socket.on('error', (error) => {\n                    reject(error);\n                });\n\n                this.socket.on('playerJoined', (playerData) => {\n                    this.gameEngine.playerId = playerData.playerId;\n                    this.messageIndex = Number(this.gameEngine.playerId) * 10000;\n                    this.socket.emit('playerDataUpdate', this.playerOptions);\n                });\n\n                this.socket.on('waitingForPlayer', (data) => {\n                    document.getElementById('waiting-room-overlay').style.display = 'block';\n                    document.getElementById('waiting-room-container').style.display = 'block';\n                    this.viewer = this.renderer.viewer = data.viewer;\n\n                    $('#start-submit').click(() => {\n                        this.socket.emit('playerReady', {viewer : this.viewer});\n                        document.getElementById('start-submit').style.visibility = 'hidden';\n                    });\n                });\n\n                this.socket.on('gameBegin', (data) => {\n                    $('#waiting-room-overlay').remove();\n                    this.gameEngine.playerReady[this.gameEngine.playerId] = true;\n                    this.renderer.groupShipPID = data.ship_pid;\n                });\n\n                this.socket.on('groupFull', () => {\n                    window.alert('Group is full, please join/create another group.');\n                    document.getElementById('name-prompt-overlay').style.display = 'block';\n                    document.getElementById('name-prompt-container').style.display = 'block';\n                });\n\n                this.socket.on('groupUpdate', (groupData) => {\n                    document.getElementById('controller_label').innerHTML = groupData.c_playerName;\n                    document.getElementById('viewer_label').innerHTML = groupData.v_playerName;\n                    document.getElementById('controller_ready_img').style.visibility =\n                        (groupData.c_ready ? 'visible' : 'hidden');\n                    document.getElementById('viewer_ready_img').style.visibility =\n                        (groupData.v_ready ? 'visible' : 'hidden');\n                });\n\n                this.socket.on('worldUpdate', (worldData) => {\n                    this.inboundMessages.push(worldData);\n                });\n\n                this.socket.on('roomUpdate', (roomData) => {\n                    this.gameEngine.emit('client__roomUpdate', roomData);\n                });\n\n                this.socket.on('disconnect', (reason) => {\n                    console.log(reason);\n                    window.alert('Server disconnected. Please refresh when server is available.');\n                    this.socket.disconnect();\n                });\n\n            });\n        };\n\n        let matchmaker = Promise.resolve({ serverURL: this.options.serverURL, status: 'ok' });\n        if (this.options.matchmaker)\n            matchmaker = Utils.httpGetPromise(this.options.matchmaker);\n\n        return matchmaker.then(connectSocket);\n    }\n}\n\nfunction isTouchDevice() {\n    return 'ontouchstart' in window || navigator.maxTouchPoints;\n}\n"],"file":"AsteroidsClientEngine.js"}